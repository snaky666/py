{% extends "base.html" %}

{% block title %}فاتورة {{ invoice.invoice_number }} - نظام POS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">فاتورة #{{ invoice.invoice_number }}</h1>
    <div class="flex gap-2">
        <a href="{{ url_for('sales_list') }}" class="btn btn-secondary">عودة للفواتير</a>
    </div>
</div>

<div class="invoice-header">
    <div class="invoice-info">
        <div class="invoice-info-item">
            <label>رقم الفاتورة</label>
            <span>{{ invoice.invoice_number }}</span>
        </div>
        <div class="invoice-info-item">
            <label>العميل</label>
            <span><a href="{{ url_for('customer_view', id=invoice.customer.id) }}">{{ invoice.customer.name }}</a></span>
        </div>
        <div class="invoice-info-item">
            <label>التاريخ</label>
            <span>{{ invoice.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
        <div class="invoice-info-item">
            <label>طريقة الدفع</label>
            <span>
                {% if invoice.payment_method == 'cash' %}
                    <span class="badge badge-success">نقدي</span>
                {% else %}
                    <span class="badge badge-info">تقسيط ({{ invoice.num_installments }} أقساط)</span>
                {% endif %}
            </span>
        </div>
        <div class="invoice-info-item">
            <label>الحالة</label>
            <span>
                {% if invoice.status == 'paid' %}
                    <span class="badge badge-success">مدفوع بالكامل</span>
                {% elif invoice.status == 'partial' %}
                    <span class="badge badge-warning">مدفوع جزئياً</span>
                {% else %}
                    <span class="badge badge-secondary">قيد الانتظار</span>
                {% endif %}
            </span>
        </div>
    </div>
</div>

<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">المنتجات</h3>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>المنتج</th>
                        <th>السعر</th>
                        <th>الكمية</th>
                        <th>الإجمالي</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice.items %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td>{{ "%.2f"|format(item.unit_price|float) }} ر.س</td>
                        <td>{{ item.quantity }}</td>
                        <td style="font-weight: 600;">{{ "%.2f"|format(item.total_price|float) }} ر.س</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: left; font-weight: 600;">إجمالي الفاتورة:</td>
                        <td style="font-weight: 700; font-size: 1.25rem; color: var(--primary-color);">
                            {{ "%.2f"|format(invoice.total_amount|float) }} ر.س
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">الملخص المالي</h3>
        </div>
        <div class="card-body">
            <div style="display: grid; gap: 1rem;">
                <div class="flex-between" style="padding: 0.75rem; background: var(--gray-100); border-radius: var(--border-radius);">
                    <span>إجمالي الفاتورة:</span>
                    <span style="font-weight: 700;">{{ "%.2f"|format(invoice.total_amount|float) }} ر.س</span>
                </div>
                <div class="flex-between" style="padding: 0.75rem; background: #d1fae5; border-radius: var(--border-radius);">
                    <span>المبلغ المدفوع:</span>
                    <span style="font-weight: 700; color: #065f46;">{{ "%.2f"|format(invoice.paid_amount|float) }} ر.س</span>
                </div>
                <div class="flex-between" style="padding: 0.75rem; background: {% if invoice.get_remaining_balance() > 0 %}#fee2e2{% else %}#d1fae5{% endif %}; border-radius: var(--border-radius);">
                    <span>المبلغ المتبقي:</span>
                    <span style="font-weight: 700; color: {% if invoice.get_remaining_balance() > 0 %}#991b1b{% else %}#065f46{% endif %};">
                        {{ "%.2f"|format(invoice.get_remaining_balance()|float) }} ر.س
                    </span>
                </div>
            </div>
            
            {% if invoice.notes %}
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--gray-100); border-radius: var(--border-radius);">
                <span class="text-muted text-sm">ملاحظات:</span>
                <p style="margin-top: 0.25rem;">{{ invoice.notes }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if invoice.payment_method == 'installment' %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h3 class="card-title">جدول الأقساط</h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>رقم القسط</th>
                    <th>تاريخ الاستحقاق</th>
                    <th>المبلغ</th>
                    <th>المدفوع</th>
                    <th>المتبقي</th>
                    <th>الحالة</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for inst in invoice.installments %}
                <tr>
                    <td>{{ inst.installment_number }}</td>
                    <td>{{ inst.due_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ "%.2f"|format(inst.amount|float) }} ر.س</td>
                    <td>{{ "%.2f"|format(inst.paid_amount|float) }} ر.س</td>
                    <td>{{ "%.2f"|format(inst.get_remaining()|float) }} ر.س</td>
                    <td>
                        {% if inst.status == 'paid' %}
                            <span class="badge badge-success">مدفوع</span>
                        {% elif inst.status == 'partial' %}
                            <span class="badge badge-warning">جزئي</span>
                        {% elif inst.status == 'overdue' %}
                            <span class="badge badge-danger">متأخر</span>
                        {% else %}
                            <span class="badge badge-secondary">قيد الانتظار</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if inst.status != 'paid' %}
                        <a href="{{ url_for('installment_pay', id=inst.id) }}" class="btn btn-success btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            تسجيل دفعة
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}
